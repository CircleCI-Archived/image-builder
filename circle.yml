machine:
  environment:
    IMAGE_TAG: 0.0.${CIRCLE_BUILD_NUM}

  post:
    - sudo curl -L -o /usr/bin/docker 'https://s3.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo service docker start

dependencies:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS

test:
  override:
    # Scratch is the latest cache
    - docker pull circleci/build-image:scratch || true:
        timeout: 3600

    - docker build -t circleci/build-image:scratch .:
        timeout: 3600

    - docker tag circleci/build-image:scratch circleci/build-image:trusty-${IMAGE_TAG}
    - docker push circleci/build-image:scratch:
        timeout: 3600
    - docker push circleci/build-image:trusty-${IMAGE_TAG}

    # Build a slightly modified image for unprivileged lxc
    - docker build --build-arg TARGET_UNPRIVILEGED_LXC=true --build-arg use_precompile=true -t circleci/build-image:scratch-unprivileged .:
        timeout: 3600

    - docker tag circleci/build-image:scratch-unprivileged circleci/build-image:trusty-${IMAGE_TAG}-unprivileged
    - docker push circleci/build-image:scratch:
        timeout: 3600
    - docker push circleci/build-image:trusty-${IMAGE_TAG}-unprivileged

deployment:
  release:
    tag: /v.*/
    commands:
      - ./docker-export circleci/build-image:scratch-unprivileged > trusty-beta-${CIRCLE_TAG}.tar.gz:
          timeout: 3600
      - aws s3 cp trusty-beta-${CIRCLE_TAG}.tar.gz s3://circle-downloads/ --acl public-read
