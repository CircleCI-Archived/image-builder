machine:
  environment:
    IMAGE_TAG: 0.0.${CIRCLE_BUILD_NUM}

  pre:
    - echo 'build_target() { git show | grep $1 > /dev/null; }' >> ~/.circlerc

  post:
    - sudo curl -L -o /usr/bin/docker 'https://s3.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo service docker start

dependencies:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS

test:
  override:
    - ? |
        if build_target "enterprise"; then
          make enterprise;
        elif build_target "dotcom"; then
          make dotcom;
        else
          echo "<<<<<< NO BUILD TARGET SPECIFIED >>>>>>>";
        fi
      :
        timeout: 3600

deployment:
  release:
    tag: /\d\d\.\d\d\.\d\d/
    commands:
      - make dotcom_deployment:
          timeout: 3600
