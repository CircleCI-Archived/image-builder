{
    "variables":{
      "aws_region": "" 
    },
    "builders": [
      {
        "type": "amazon-ebs",
        "region": "{{user `aws_region`}}",
        "source_ami_filter": {
          "filters": {
            "virtualization-type": "hvm",
            "root-device-type": "ebs",
            "name": "ubuntu/images/hvm-ssd/ubuntu-xenial-16.04-amd64-server-*"
          },
          "owners": [
            "099720109477"
          ],
          "most_recent": true
        },
        "instance_type": "t3.medium",
        "ami_name": "ubuntu-1604-vm-circleci-classic-{{timestamp}}",
        "ssh_username": "circleci",
        "ami_groups": "all",
        "user_data": "#cloud-config\nsystem_info:\n  default_user:\n    name: circleci\n"
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "inline": [
          "sleep 30",
          "mkdir -p /tmp/circleci-provisioner"
        ]
      },
      {
        "type": "file",
        "source": "./",
        "destination": "/tmp/circleci-provisioner"
      },
      {
        "type": "shell",
        "inline": [
          "cd /tmp/circleci-provisioner && sudo su root -c './provision.sh'"
        ]
      },
      {
        "type": "shell",
        "inline": [
          "set -ex",
          "sudo apt-get purge sshguard",
          "sudo sed -i -e '/APT::Periodic::Update-Package-Lists/g' /etc/apt/apt.conf.d/10periodic",
          "echo 'APT::Periodic::Unattended-Upgrade \"0\";' | sudo tee -a /etc/apt/apt.conf.d/10periodic",
          "sudo rm -rf ~/.ssh/authorized_keys /tmp/circleci-provisioner",
          "echo yay it finished"
        ]
      }
    ]
  }