{
    "variables": {
        "docker_version_to_install": "17.06.0~ce-0~ubuntu"
    },
    "builders" : [
        {
            "type": "amazon-ebs",
            "source_ami_filter": {
                "filters": {
                  "virtualization-type": "hvm",
                  "name": "ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*",
                  "root-device-type": "ebs"
                },
                "owners": ["099720109477"],
                "most_recent": true
              },
            "ssh_username": "circleci",
            "user_data_file": "aws_user_data",
            "ami_regions": ["us-east-1","us-east-2","us-west-1","us-west-2","ca-central-1","eu-west-1","eu-central-1","eu-west-2","ap-northeast-1","ap-northeast-2","ap-southeast-1","ap-southeast-2","ap-south-1","sa-east-1"],
            "ami_groups": "all"
        }
    ],
    "provisioners" : [
        {
            "type" : "shell",
            "inline" : [
                "sleep 30",
	        "mkdir -p /tmp/circleci-provisioner"
	    ]
        },
        {
            "type": "file",
            "source": "./",
            "destination": "/tmp/circleci-provisioner"
        },
        {
            "type" : "shell",
            "inline" : [
                "cd /tmp/circleci-provisioner && sudo su root -c './provision.sh {{user `docker_version_to_install`}}' &&  echo done",

                "sudo apt-get purge sshguard",
                "sudo rm -rf /home/circleci/.ssh/authorized_keys /tmp/circleci-provisioner",
                "echo after done",
	        "exit 0"
	    ]
        }
    ]
}
